<div class="chat-wrapper" [class]="rgbMode">
  <button mat-fab color="primary" class="chat-fab-button" (click)="toggleChat()">
    <mat-icon>{{ isOpen() ? 'close' : 'chat' }}</mat-icon>
  </button>

  @if (isOpen()) {
    <mat-card class="chat-card elevation-z8" [class.animate-entry]="isOpen()" [class.expanded]="isExpanded()">

      <mat-card-header class="chat-header">
        <div mat-card-avatar class="header-avatar">
          <mat-icon>smart_toy</mat-icon>
        </div>
        <mat-card-title>Leandro AI</mat-card-title>
        <mat-card-subtitle class="status-online">‚óè Online (v21)</mat-card-subtitle>
        <button mat-icon-button class="expand-button" (click)="toggleExpand()">
          <mat-icon>{{ isExpanded() ? 'close_fullscreen' : 'open_in_full' }}</mat-icon>
        </button>
      </mat-card-header>

      <mat-card-content class="chat-content" #scrollContainer>

        @for (msg of messages(); track $index) {
          <div class="message-row" [class.user-row]="msg.isUser">
            <div class="message-bubble" [class.user-bubble]="msg.isUser" [class.bot-bubble]="!msg.isUser" [innerHTML]="formatMessage(msg.text)">
            </div>
          </div>
        }

        @if (isLoading()) {
          <div class="loading-container">
            <mat-spinner diameter="20"></mat-spinner>
            <span>Processando...</span>
          </div>
        }
      </mat-card-content>

      <div class="chat-actions">
        <mat-form-field appearance="outline" class="full-width no-bottom-padding">
          <mat-label>Digite sua pergunta...</mat-label>
          <input matInput
                 [ngModel]="userQuestion()"
                 (ngModelChange)="userQuestion.set($event)"
                 (keyup.enter)="sendMessage()"
                 [disabled]="isLoading()">

          <button mat-icon-button matSuffix (click)="sendMessage()" [disabled]="!userQuestion() || isLoading()">
            <mat-icon>send</mat-icon>
          </button>
        </mat-form-field>
      </div>

    </mat-card>
  }
</div>
